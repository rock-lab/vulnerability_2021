

# Vulnerability modeling - parallel

# Imports ----
source("vulnerability_modeling_tools.R")
source("vulnerability_plotting_tools.R")


# Options ----
Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)



# Main ----
args = commandArgs(trailingOnly=TRUE)

# test if there is at least one argument: if not, return an error
if (length(args)==0) {
  args = c("H37Rv", "test", "example_H37Rv_data.txt", "data/H37Rv/test/")
}


  
desired_strain = args[1]
label = args[2]
DATA_PATH = args[3]
basedir_data= args[4]
desired_gene_path = ""
DEBUG = FALSE
if(length(args) > 4){
    DEBUG = TRUE
    desired_gene_path = args[5]
}


XFULL = read.table(DATA_PATH, sep=",", stringsAsFactors = FALSE, header=T)
ii_bad = is.na(XFULL$ESS)
XFULL$ESS[ii_bad] = "N/A"

data = XFULL
unique_genes = unique(data$ORF)
 

mclapply(unique_genes, plot_samples, mc.cores=40, strain=desired_strain,
         folder=label, basedir_data=basedir_data)


