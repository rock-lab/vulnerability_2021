

# Vulnerability modeling - parallel

# Imports ----
source("vulnerability_modeling_tools.R")
source("vulnerability_plotting_tools.R")


# Options ----
Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)



# Main ----
args = commandArgs(trailingOnly=TRUE)

# test if there is at least one argument: if not, return an error
if (length(args)==0) {
  args = c("H37Rv", "test", "example_H37Rv_data.txt")
}


  
desired_strain = args[1]
label = args[2]
DATA_PATH = args[3]
desired_gene_path = ""
DEBUG = FALSE
if(length(args) > 3){
    DEBUG = TRUE
    desired_gene_path = args[4]
}




unique_genes = unique(data$ORF)
 
dir.create(file.path("data", desired_strain, label), showWarnings = FALSE)


gene = unique_genes[1]
message("Creating model...")  
vb_model = stan_model(stancode.filepath, save_dso = TRUE)
  
message("Running Stan on all genes...")

mclapply(unique_genes, plot_samples, mc.cores=40, strain=desired_strain,
         folder=label)


