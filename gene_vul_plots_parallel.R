

# Vulnerability modeling - parallel

# Imports ----
source("vulnerability_modeling_tools.R")
source("vulnerability_plotting_tools.R")

require("optparse")



# Options ----

# Main ----
args = commandArgs(trailingOnly=TRUE)

# test if there is at least one argument: if not, return an error
option_list = list(
    # Data stuff:
    make_option("--data", type="character", default="",
              help="Input data"),
    make_option("--dir", type="character", default="./",
              help="Base data dir"),
    make_option("--strain", type="character", default="",
              help="The strain used for this data e.g. H37Rv"),
    make_option("--label", type="character", default="",
              help="Label to use aka strain_exp_date"),
    make_option("--genes", type="character", default="",
              help="Gene path"),


    #System stuff:
    make_option("--cores", type="numeric", default=20,
              help="Number of cores to use"),
    

    # plotting stuff:
    make_option("--ymax", type="numeric", default=0.05,
              help="Max value for the y-axis"),
    make_option("--ymin", type="numeric", default=-1.0,
              help="minimum for the y-axis")
);


opt_parser = OptionParser(option_list=option_list);
opt = parse_args(opt_parser);

desired_strain = opt$strain
label = paste(opt$label, sep="_")


has_necessary_stuff = opt$label !="" & opt$strain !=""
stopifnot(has_necessary_stuff)

if (file.exists(opt$data)){
    DATA_PATH = opt$data
} else {
   DATA_PATH = file.path(opt$dir, paste0("data_", label, ".txt"))
}

DEBUG = FALSE

XFULL = read.table(DATA_PATH, sep=",", stringsAsFactors = FALSE, header=T)
ii_bad = is.na(XFULL$ESS)
XFULL$ESS[ii_bad] = "N/A"

data = XFULL
unique_genes = unique(data$ORF)
 

mclapply(unique_genes, plot_samples, mc.cores=opt$cores, strain=desired_strain,
         folder=label, prefix=opt$dir)


