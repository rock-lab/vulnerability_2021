

# Vulnerability modeling - parallel

# Imports ----
source("vulnerability_modeling_tools.R")
source("vulnerability_plotting_tools.R")

require("optparse")



# Options ----

# Main ----
args = commandArgs(trailingOnly=TRUE)

# test if there is at least one argument: if not, return an error
if (length(args)==0) {
  args = c("H37Rv", "test", "example_H37Rv_data.txt", "data/H37Rv/test/")
} else {

    option_list = list(
        # Data stuff:
        make_option(c("-i", "--input"), type="character", default="",
                  help="Input data"),
        make_option(c("-d", "--dir"), type="character", default="./",
                  help="Base data dir"),
        make_option(c("-s", "--strain"), type="character", default="",
                  help="The strain used for this data e.g. H37Rv"),
        make_option(c("-l", "--label"), type="character", default="",
                  help="Label to use aka strain_exp_date"),
        make_option(c("-g", "--genes"), type="character", default="",
                  help="Gene path"),

        # plotting stuff:
        make_option(c("-t", "--ymax"), type="numeric", default=0.05,
                  help="Max value for the y-axis"),
        make_option(c("-b", "--ymin"), type="numeric", default=-1.0,
                  help="minimum for the y-axis")
    );

}

opt_parser = OptionParser(option_list=option_list);
opt = parse_args(opt_parser);

desired_strain = opt$strain
label = paste(opt$label, sep="_")

if (file.exists(opt$input)){
    DATA_PATH = opt$input
} else {
   DATA_PATH = file.path(opt$dir, paste0("data_", label, ".txt"))
}

DEBUG = FALSE

XFULL = read.table(DATA_PATH, sep=",", stringsAsFactors = FALSE, header=T)
ii_bad = is.na(XFULL$ESS)
XFULL$ESS[ii_bad] = "N/A"

data = XFULL
unique_genes = unique(data$ORF)
 

mclapply(unique_genes, plot_samples, mc.cores=40, strain=desired_strain,
         folder=label, basedir_data=basedir_data)


