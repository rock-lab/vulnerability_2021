
# Vulnerability plotting tools ----

# Imports ----
require(parallel)
require(reshape2)

require(ggplot2)
#library(magick)

require(plyr)
require(dplyr)

require(pals)

# Data ----
H37Rv_SGRNA_DATA_FILE = "clean_data_H37Rv_ref_10_14_2020.txt"
HN878_SGRNA_DATA_FILE = "clean_data_HN878_ref_10_14_2020.txt"
Smeg_SGRNA_DATA_FILE = "clean_data_Smeg_ref_10_14_2020.txt"


H37Rv_SGRNA_FIT_FILE = "result_sgrna_fit_2line_H37Rv_ref.txt"
HN878_SGRNA_FIT_FILE = "result_sgrna_fit_2line_HN878ref.txt"
Smeg_SGRNA_FIT_FILE = "result_sgrna_fit_2line_Smeg_ref.txt"


H37Rv_VULN_DATA_FILE = "prelim_vuln_H37Rv_ref_10_14_2020.txt"
HN878_VULN_DATA_FILE = "prelim_vuln_HN878_ref_10_14_2020.txt"
Smeg_VULN_DATA_FILE = "prelim_vuln_Smeg_ref_10_14_2020.txt"


H37Rv_REF_LABEL = "H37Rv_ref_10_14_2020"
HN878_REF_LABEL = "HN878_ref_10_14_2020"
SMEG_REF_LABEL = "Smeg_ref_10_14_2020"



# Colors  ----

# Global color variables
BLACK = "#000000"
DARKGRAY = "#747474"
ORANGE = "#E69F00"
LIGHTBLUE = "#56B4E9"
GREEN = "#009E73"
YELLOW = "#F0E442"
BLUE = "#0072B2"
RED = "#D55E00"
PINK = "#CC79A7"
PURPLE = "#3D348B"

VULN_COLOR_OLD = "#FD8D3C"
INV_COLOR_OLD = "#969696"

VULN_COLOR = "#6A51A3"
INV_COLOR = "#969696"

CLUSTER_BLUE = "#1f84ff"

ES_COLOR = RED
UN_COLOR = PURPLE
NE_COLOR = BLUE

GRAY = "#7B848F"
BROWN = "#C85200"
TAN = "#FFBC79"

LIGHTGRAY = "#D6CFC7"
GRAY2 = "#787276"
SUPERDARKGRAY = "#222021"

BLACK_BORDER = "#747474"
DARKGRAY_BORDER = "#525151"
ORANGE_BORDER = "#E68A00"
LIGHTBLUE_BORDER = "#569BE9"
GREEN_BORDER = "#017C5B"
YELLOW_BORDER = "#F0CD42"
BLUE_BORDER = "#035A8C"
RED_BORDER = "#B83502"
PINK_BORDER = "#bd6f73"


fill_palette <- c(BLACK, RED, BLUE, GREEN)
border_palette <- c(BLACK_BORDER, RED_BORDER, BLUE_BORDER, GREEN_BORDER)


# Global limit variables

# BETA_MIN = -0.45
# BETA_MAX = 0.05
# Y_MIN = -6
# Y_MAX = 1

BETA_MIN = -1.05
BETA_MAX = 0.05
#
Y_MIN = -14.5
Y_MAX = 1

RATIO_MIN =-5.0
RATIO_MAX = 0.5

# Settings  ----
# Setting up ggplot theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size=15), title = element_text(size=18),
             axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
             axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(), panel.border = element_rect(size=2),
             legend.text = element_text(size=15))


# Functions  ----


clean_string = function(X){
  return(gsub(":", "_", X))
}

pam_motifs = c("NNAGAAG","NNAGAAT","NNAGAAA","NNGGAAG","NNAGAAC",
               "NNGGAAA","NNAGCAT","NNAGGAG","NNAGGAT","NNAGCAA",
               "NNGGAAC","NNGGAAT","NNAGCAG","NNAGGAA","NNAGGAC",
               "NNGGGAG","NNGGGAT","NNGGGAA","NNAGCAC","NNGGGAC",
               "NNGGCAT","NNGGCAG","NNGGCAA","NNGGCAC", "")


old_pams = c(1, 2, 3, 4, 5,
             6, 7, 8, 9, 10,
             11,12,13,14,15,
             16,17,18,19,20,
             21,22,23,24, NA)


new_pams = c(3,1,2,6,7,
             5,11,13,8,9,
             10,4,15,12,14,
             19,16,17,18,21,
             20,23,22,24,NA)


# pam_motifs = c("NNAGAAA",  "",  "NNAGAAC",  
#                "NNGGCAT",  "NNAGAAG",  "NNAGCAT",  
#                "NNGGCAA",  "NNGGCAC",  "NNAGAAT",  
#                "NNGGCAG",  "NNAGCAG",  "NNAGCAC",  
#                "NNAGCAA",  "NNGGAAG",  "NNGGGAT",  
#                "NNGGAAC",  "NNGGAAA",  "NNAGGAT",  
#                "NNAGGAC",  "NNAGGAA",  "NNGGAAT",  
#                "NNGGGAA",  "NNGGGAC",  "NNGGGAG",  
#                "NNAGGAG")
# 
# old_pams = c(3,  NA,  5,  
#              21,  1,  7,  
#              23,  24,  2,  
#              22,  13,  19,  
#              10,  4,  17,  
#              11,  6,  9,  
#              15,  14,  12,  
#              18,  20,  16,
#              8)
# 
# new_pams = c(2,  NA,  6,
#              20,  4,  9,
#              21,  24,  1,
#              23,  15,  18,
#              12,  7,  16,
#              13,  5,  8,
#              14,  11,  3,
#              17,  22,  19,
#              10)




norm_to_unit = function(x, min_x=NULL, max_x=NULL){
  if (is.null(min_x)){
    min_x = numpy.min(x)
  }
  if(is.null(max_x)){
    max_x = numpy.max(x)
  }
return ((x - min_x) / (max_x - min_x))
}

convert_new_to_old_pam = function(PAM){
  return(plyr::mapvalues(PAM, new_pams, old_pams, warn_missing = FALSE))
}

convert_new_to_old_pam_seq = function(PAM){
  return(plyr::mapvalues(PAM, new_pams, pam_motifs, warn_missing = FALSE))
}

convert_old_to_new_pam = function(PAM){
  return(plyr::mapvalues(PAM, old_pams, new_pams, warn_missing = FALSE))
}

convert_old_to_new_pam_seq = function(PAM){
  return(plyr::mapvalues(PAM, old_pams, pam_motifs, warn_missing = FALSE))
}

data_summary_mean <- function(x) {
  m <- mean(x)
  ymin <- m-sd(x)
  ymax <- m+sd(x)
  return(c(y=m,ymin=ymin,ymax=ymax))
}

data_summary_median <- function(x) {
  Q = quantile(x, na.rm=TRUE)
  return(c(y=Q[[3]], ymin=Q[[2]] ,ymax=Q[[4]]) )
}


get_gene_samples_path = function(gene, label="", basedir="./"){
  clean_gene = gsub(":", "_", gene)

  full_label = clean_gene
  if(label !="") {
    full_label = paste(clean_gene, label, sep="_")
  }
  filename =  paste("sample_vb_betalogistic_fit_",full_label, ".txt", sep="")
  path = file.path(basedir, filename)
  return(path)
}

get_gene_model_data_path = function(gene, label="", basedir="./"){
  clean_gene = gsub(":", "_", gene)
  full_label = clean_gene
  if(label !="") {
    full_label = paste(clean_gene, label, sep="_")
  }
  filename =  paste("model_data_",full_label,".Rds", ".txt", sep="")
  path = file.path(basedir, filename)
  return(path)
}


lm_eqn <- function(df, formula){
  m <- lm(formula, df);
  eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
                   list(a = format(unname(coef(m)[1]), digits = 3),
                        b = format(unname(coef(m)[2]), digits = 3),
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));
}


# Function to compare 2+ genes
plot_comparisons = function(X, label="", prefix=".", 
                            output_prefix="./plots/comparisons",
                            fill_palette = c("#747474", "#D55E00"),
                            border_palette = c("#747474", "#D55E00"), full_label="", 
                            width=NULL, height=NULL,
                            style="std", band_alpha=0.3, str_resolution = 0.1,
                            summary_size=4, samples=1000,
                            min_max_path=NULL,
                            basedir_data="data/"){
 

  default_fill = c("#747474", "#D55E00")
  default_border = c("#747474", "#D55E00")
  comparison_list = NULL
  i = 0
  fill_palette_list = c()
  border_palette_list = c()
  full_label_list = c()
  for(geneX in X){
    
    
    clean_gene = gsub(":", "_", geneX$gene)
    #message("Strain: ", geneX$strain, "  Gene: ", geneX$gene)
    #message(sprintf("prefix: %s", prefix))
    
    basedir = file.path(basedir_data, geneX$strain, geneX$folder)
    sample_file_path = get_gene_samples_path(clean_gene, geneX$strain, basedir=basedir)
    #message(sprintf("sample_file_path: %s", sample_file_path))
    sample_path = file.path(prefix, sample_file_path)
    
    
    model_data_path = get_gene_model_data_path(clean_gene, geneX$strain, basedir=basedir)
    #message(sprintf("model_data_path: %s", model_data_path))
    data_path = file.path(prefix, model_data_path)
    
    #message(sprintf("sample_path_prefix: %s", prefix))
    #message(get_gene_samples_path(clean_gene, geneX$strain, basedir=geneX$folder))
    print(sample_path)
    if(!file.exists(sample_path) | !file.exists(data_path)){
    
      return(full_label_list)
    }
    fit_samples = read.csv(sample_path, comment.char="#")
    model_data = readRDS(data_path)
    i = i + 1
    comparison_list[[i]] = list(geneX$strain, clean_gene, geneX$label,  fit_samples, model_data)
    full_label_list = c(full_label_list, geneX$strain, clean_gene)
    if (is.null(geneX$fill_palette)){
      fill_palette_list = c(fill_palette_list, fill_palette[i])
    } else {
      fill_palette_list = c(fill_palette_list, geneX$fill_palette)
    }
    
    if (is.null(geneX$border_palette)){
      border_palette_list = c(border_palette_list, border_palette[i])
    } else {
      border_palette_list = c(border_palette_list, geneX$border_palette)
    }

    # comparison_list[[i]] = list(geneX[[1]]$strain, clean_gene, fit_samples, model_data)
    # full_label_list = c(full_label_list, geneX[[1]]$strain, geneX[[1]]$gene)
  }

  if(full_label ==""){
    if(label==""){
      full_label = paste(full_label_list, collapse="_")
    } else {
      full_label = paste(c(unique(full_label_list), label), collapse ="_")
    }
  }
  
  # fill_palette = c("#747474", "#D55E00")
  # border_palette = c("#000000", "#B83502")
  # Curve
  dir.create(output_prefix, showWarnings = FALSE, recursive=TRUE)
  output_path = file.path(output_prefix, paste("plot_betalogistic_fits_",
                      full_label, ".png", sep=""))
  # plot_multiple_fits(comparison_list, output_path, 
  #                    fill_palette=fill_palette_list,
  #                    border_palette=border_palette_list, width=width, height=height)
  
  plot_multiple_fits(comparison_list, output_path, 
                     fill_palette=fill_palette_list,
                     border_palette=border_palette_list, 
                     width=width, height=height,
                     style=style, band_alpha=band_alpha,
                     str_resolution=str_resolution, summary_size=summary_size,
                     samples=samples)
  
  
  # Ratio
  output_path = file.path(output_prefix, paste("plot_ratio_fits_",
                      full_label, ".png", sep=""))
  plot_multiple_ratio(comparison_list, output_path,
                      fill_palette=fill_palette_list,
                      border_palette=border_palette_list,
                      width=width, height=height,
                      min_max_path=min_max_path)
  
  return(full_label_list)
}


# Function to compare logistic fits of 2+ genes
plot_multiple_fits= function(X_list, output_path,
                              fill_palette = c("#747474", "#D55E00"),
                              border_palette = c("#747474", "#D55E00"), 
                             width=NULL, height=NULL,
                             style="std", band_alpha=0.3, summary_size=2,
                             samples=5000, str_resolution = 0.0001){
  
  
  g = ggplot() +  xlim(0, 1) +
    ylab("Estimated Beta_E") + xlab("Predicted Strength") + 
    scale_y_continuous(limits=c(BETA_MIN, BETA_MAX), breaks=c(0, -0.2, -0.4, -0.6, -0.8, -1.0))
  
  
  
  full_labels = c()
  count = 1
  for(X in X_list) {
    
    strain = X[[1]]
    clean_gene = X[[2]]
    label = X[[3]]
    fit_samples = X[[4]]
    model_data = X[[5]]
    # print(X)
    
    S = seq(0, 1, str_resolution)
    DF_l = data.frame(S=S)
    for(i in 1:samples){
      A = fit_samples[["A.2"]][i]
      K = fit_samples[["A.1"]][i]
      B = fit_samples[["B"]][i]
      M = fit_samples[["M"]][i]
      Y = A + (K-A) / (1+exp(-B * (S-M)))
      DF_l[[paste("Y", i,sep="")]] = Y
    }
    line_df = melt(DF_l, id = "S")
    line_df["Gene"] = clean_gene
    line_df["Strain"] = strain
    
    if(label %in% full_labels){
      label = paste(label, count)
    }
    line_df["label"] = label
    
    A = mean(fit_samples[["A.2"]])
    K = mean(fit_samples[["A.1"]])
    B = mean(fit_samples[["B"]])
    M = mean(fit_samples[["M"]])
    SD = mean(fit_samples[["beta_e_sigma"]])
    Y = A + (K-A) / (1+exp(-B * (S-M)))
    
    if(style == "extent") {
      
      Y_max = apply(DF_l[,-1], 1, max)
      ii_too_big = Y_max > BETA_MAX
      Y_max[ii_too_big] = BETA_MAX
      
      Y_min = apply(DF_l[,-1], 1, min)
      ii_too_small = Y_min < BETA_MIN
      Y_min[ii_too_small] = BETA_MIN
      
    } else if(style=="hdi"){
      
      Y_max = apply(DF_l[,-1], 1, HDInterval::hdi)[2,]
      ii_too_big = Y_max > BETA_MAX
      Y_max[ii_too_big] = BETA_MAX
      
      Y_min = apply(DF_l[,-1], 1, HDInterval::hdi)[1,]
      ii_too_small = Y_min < BETA_MIN
      Y_min[ii_too_small] = BETA_MIN
      
    } else {
      Y_max = Y + 1*SD
      ii_too_big = Y_max > BETA_MAX
      Y_max[ii_too_big] = BETA_MAX
      
      Y_min = Y - 1*SD
      ii_too_small = Y_min < BETA_MIN
      Y_min[ii_too_small] = BETA_MIN
      }
    
    
    summary_df = data.frame(S=S,Y=Y, Ymin = Y_min, Ymax = Y_max, Gene=clean_gene, label=label)
    
    
    full_labels = c(full_labels, label)

    # Draw error/noise depending on style
    if(style%in% c("std", "extent", "hdi")){ 
      g = g + geom_ribbon(data=summary_df, 
                         aes(x=S, ymax = Ymax, ymin=Ymin,  fill=label),
                         alpha=band_alpha)
      

      
    } else if (style=="lines") {
      
      g = g+ geom_line(data=line_df,
                       aes(x=S, y=value, group=variable),
                       alpha=band_alpha, size=2, color=border_palette[count])
    }
    
    # Draw summary
    g = g+ geom_line(data=summary_df, 
                     aes(x=S, y=Y,  color=label),
                     alpha=1.0, size=summary_size)
    
    count = count + 1
    
  }
  
  
  g = g + scale_color_manual(values=fill_palette, 
                             name="Strain",
                             breaks=full_labels,
                             labels=full_labels)
  if(style%in% c("std", "extent", "hdi")) {
    g = g + scale_fill_manual(values=fill_palette, 
                              name="Strain",
                              breaks=full_labels,
                            labels=full_labels)
  }
  
  plot(g)
  message(sprintf("Saving to: %s", output_path))
  ggsave(output_path, dpi=300, width = width, height=height)
  
}




# Plots a histograms of the vulnerability ratio
plot_multiple_ratio = function(X_list, output_path,
                               fill_palette = c("#747474", "#D55E00"),
                               border_palette = c("#747474", "#D55E00"), 
                               width=NULL, height=NULL,
                               min_max_path=NULL){
  
  
  if(!is.null(min_max_path)){
    
    min_max_df = read.csv(min_max_path)
  }
  multi_hist_list = list()
  multi_hdi_list = list()
  gene_order = c()
  full_labels = c()
  for(X in X_list) {
   
    #print(X) 
    strain = X[[1]]
    clean_gene = X[[2]]
    label = X[[3]]
    fit_samples = X[[4]]
    model_data = X[[5]]
    
    if(label %in% full_labels){
      label = paste(label, count)
    }
    full_labels = c(full_labels, label)
    
    K = fit_samples[["A.1"]]
    
    if(!is.null(min_max_path)){
      K = 1.0 - norm_to_unit(K[1:5000], min_x=min_max_df$min, max_x=min_max_df$max)
    }
    M = fit_samples[["M"]]
    hist_df = data.frame(x=K[1:5000]/M[1:5000])
    hist_df[["label"]] =  label
    gene_order = c(gene_order, label)
    
    H = HDInterval::hdi(hist_df$x)
    hdi_df = data.frame(lower=H[["lower"]], upper=H[["upper"]], label=label)
    hdi_df[["label"]] = label
    multi_hist_list[[length(multi_hist_list)+1]] = hist_df
    multi_hdi_list[[length(multi_hdi_list)+1]] = hdi_df
    }
  
  multi_hist_df = bind_rows(multi_hist_list)
  multi_hdi_df = bind_rows(multi_hdi_list)

  
  g = ggplot(multi_hist_df, aes(x = x, fill=label, color=label)) +
    ylab("Density") + 
    xlab("Vulnerability Ratio") + 

    geom_histogram(aes(y=..density..), position="identity", alpha=0.9, size=0.5, bins=150) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
    geom_vline(data=multi_hdi_df, aes(xintercept = lower), color=DARKGRAY_BORDER, size=1.0, linetype="dashed") +
    geom_vline(data=multi_hdi_df, aes(xintercept = upper), color=DARKGRAY_BORDER, size=1.0, linetype="dashed")
  
  
  g = g + scale_fill_manual(values=fill_palette, 
                               name="Strain",
                               breaks=full_labels,
                               labels=full_labels) +
    scale_color_manual(values=border_palette, 
                             name="Strain",
                             breaks=full_labels,
                             labels=full_labels)
  
  # plot(g)
  ggsave(output_path, dpi=300, width=width, height=height-4)
  
}


# Function to compare logistic fits of 2+ genes
plot_multiple_twoline_fits = function(X_list, output_path,
                              fill_palette = c("#747474", "#D55E00"),
                              border_palette = c("#747474", "#D55E00"), width=NULL, height=NULL){
  
  
  g = ggplot() +  xlim(0, 1) +
    ylab("sgRNA log2FC") + xlab("Generations") + 
    scale_y_continuous(limits=c(BETA_MIN, BETA_MAX), breaks=c(0, -0.2, -0.4, -0.6, -0.8, -1.0))
  
  
  
  full_labels = c()
  count = 1
  
  J = X_list[1][[5]][["J"]]
  for(j in 1:J){
    for(X in X_list) {
      
      
      strain = X[[1]]
      clean_gene = X[[2]]
      label = X[[3]]
      fit_samples = X[[4]]
      model_data = X[[5]]
      # print(X)
      
      S = seq(0, 1, 0.01)
  
      alpha_l = mean(fit_samples[[sprintf("beta.%s.1", j)]])
      beta_l = mean(fit_samples[[sprintf("beta.%s.2", j)]])
      gamma = mean(fit_samples[[sprintf("beta.%s.3", j)]])
      beta_e = mean(fit_samples[[sprintf("beta_e.%s", j)]])

      ii_pam = model_data$pam==j
      data_df = data.frame(generations=model_data$x[ii_pam], 
                           Y=model_data$y[ii_pam], str=model_data$s[ii_pam])
      
      
      summary_df = data.frame(S=S,Y=Y, Gene=clean_gene, label=label)
      
      
      full_labels = c(full_labels, label)
      g = g+ geom_line(data=line_df,
                       aes(x=S, y=value, group=variable, color=label),
                       alpha=0.01, size=2)
      
      g = g+ geom_line(data=summary_df, 
                       aes(x=S, y=Y,  color=label),
                       alpha=1.0, size=2)
      
      count = count + 1
      
    }
    
    
    g = g + scale_color_manual(values=fill_palette, 
                               name="Strain",
                               breaks=full_labels,
                               labels=full_labels)
    
    
    plot(g)
    ggsave(output_path, dpi=300, width = width)
  }
  
}








# High-level function to make multiple plots from samples
plot_samples = function(X, strain, folder="", label="", base_dir="./",
                        do_animation=FALSE, desired_guides=NULL,
                        highlight=NULL, plot_M_hdi=FALSE,
                        plot_beta_max_hdi=FALSE,
                        basedir="plots",
                        basedir_data=""){
  gene = X[1]

  require(HDInterval)

  if(do_animation){
    require("animation")
    # Setting up options for animations
    ani.options(ani.res=150, ani.width=1000, ani.height=1000)
    ani.options( ani.width=1000, ani.height=1000)
  }


  # gene = "RVBD0206c:mmpL3"
  
  clean_gene = gsub(":", "_", gene)
  message("Gene: ", gene)
  # Paths
  #base_plot_path = paste("plots/", strain, "/", sep="")
  base_plot_path = file.path(basedir, strain, folder)
  dir.create(base_plot_path, recursive=TRUE)

  sample_file_path = get_gene_samples_path(gene,  strain, basedir_data)
  data_path = get_gene_model_data_path(gene,  strain, basedir_data)
  
  # data
  fit_samples = read.csv(sample_file_path, comment.char="#")
  model_data = readRDS(data_path)
  # plotting

  plot_ratio(clean_gene, strain, fit_samples, model_data, base_plot_path)
  plot_betalogistic_fit(clean_gene, strain,  fit_samples, model_data, base_plot_path,
                        highlight=highlight, plot_M_hdi=plot_M_hdi,
                        plot_beta_max_hdi=plot_beta_max_hdi)
  
  if(do_animation){
    plot_betalogistic_fit_animation(clean_gene, strain, fit_samples, model_data, base_plot_path)
  }
  # plot_sigma_heatmap(clean_gene, strain, fit_samples, model_data, base_plot_path)
  
  # guides = unique(c(1, model_data$pam[model_data$y==min(model_data$y)]))
  if(is.null(desired_guides)){  
    select_guides = unique(c(which.min(model_data$s), which.max(model_data$s)))
  } else {
    select_guides = desired_guides
  }
  for(j in select_guides){
  # for(j in 1:model_data$J){
    plot_twoline_fit(clean_gene, strain, fit_samples, model_data, j, base_plot_path)
    if(do_animation){
      plot_twoline_fit_animation(clean_gene, strain, fit_samples, model_data, j, base_plot_path)
    }
  }
}


plot_sigma_heatmap = function(gene,  strain, fit_samples, model_data, base_plot_path){
  
  X = c()
  Y = c()
  V = c()
  parameter = c("alpha_L", "beta_L", "gamma")
  
  for(i in 1:3){
    for(j in 1:3){
      X = c(X, parameter[i])
      Y = c(Y, parameter[j])
      val = mean(fit_samples[[paste("Omega",i,j, sep=".")]])
      V = c(V, val)
    }
  }
  
  heat_df = data.frame(x=X, y=Y, scale=V)
  
  ggplot(heat_df, aes(x = x, y = y, fill=scale)) +
    theme_bw()+
    # scale_x_discrete(values=c(1,2,3), labels= c("alpha_L", "beta_L", "gamma"))+
    ylab("Parameter") + xlab("Parameter") + labs(title=gene) + 
    geom_tile()
  extended_path = file.path(base_plot_path, "correlation_heatmap/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path, 
        paste("plot_omega_heatmap_", strain, "_", gene, ".png", sep="")), dpi=300)
}
  



# Plots the logistic fit from samples
plot_betalogistic_example = function(gene, strain, fit_samples, model_data, base_plot_path){

  S = seq(0, 1, 0.01)
  # Summary line
  DF_summary = data.frame(S=S)
  A = mean(fit_samples[["A.2"]])
  K = mean(fit_samples[["A.1"]])
  B = mean(fit_samples[["B"]])
  M = mean(fit_samples[["M"]])
  Y = A + (K-A) / (1+exp(-B * (S-M)))
  DF_summary = data.frame(S=S, Y=Y)

  M_hdi = HDInterval::hdi(fit_samples[["M"]])
  beta_max_hdi = HDInterval::hdi(fit_samples[["A.1"]])
  M_hdi_df = data.frame(upper=M_hdi[2], lower=M_hdi[1], mean=M)
  beta_max_hdi_df = data.frame(upper=beta_max_hdi[2], lower=beta_max_hdi[1], mean=K)

  ggplot(DF_summary, aes(x = S, y = Y)) +
    xlim(0, 1) +  theme_bw()+
    ylab("Estimated Beta_E") + xlab("Predicted Strength") + labs(title=gene) +
    scale_y_continuous(limits=c(BETA_MIN, BETA_MAX), 
                       breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0)) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
    geom_line(color="black", size=2) +
    # M HDI
    geom_vline(data=M_hdi_df, aes(xintercept=upper), linetype = "dashed", color=DARKGRAY) +
    geom_vline(data=M_hdi_df, aes(xintercept=lower), linetype = "dashed", color=DARKGRAY) +
    # Beta max HDI
    geom_hline(data=beta_max_hdi_df, aes(yintercept=upper), linetype = "dashed", color=DARKGRAY) +
    geom_hline(data=beta_max_hdi_df, aes(yintercept=lower), linetype = "dashed", color=DARKGRAY)

    # geom_line(data=line_df, aes(x=S, y=value, group=variable), color="black", alpha=0.05, size=2)

  extended_path = file.path(base_plot_path, "betalogistic_example/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path,
        paste("plot_betalogistic_example_", strain, "_", gene, "_black.png", sep="")), dpi=300)

}




# Plots the logistic fit from samples
plot_betalogistic_fit = function(gene, strain, fit_samples, model_data, base_plot_path,
                                 width=10, height=10, highlight=NULL, plot_M_hdi=FALSE,
                                 plot_beta_max_hdi=FALSE){
  
  S = seq(0, 1, 0.01)
  DF_l = data.frame(S=S)
  DF_summary = data.frame(S=S)
  for(i in 1:1000){
    A = fit_samples[["A.2"]][i]
    K = fit_samples[["A.1"]][i]
    B = fit_samples[["B"]][i]
    M = fit_samples[["M"]][i]
    Y = A + (K-A) / (1+exp(-B * (S-M)))
    DF_l[[paste("Y", i,sep="")]] = Y
  }
  # Summary line
  DF_summary = data.frame(S=S)
  A = mean(fit_samples[["A.2"]])
  K = mean(fit_samples[["A.1"]])
  B = mean(fit_samples[["B"]])
  M = mean(fit_samples[["M"]])
  Y = A + (K-A) / (1+exp(-B * (S-M)))
  DF_summary = data.frame(S=S, Y=Y)

  M_hdi = HDInterval::hdi(fit_samples[["M"]])

  beta_max_hdi = HDInterval::hdi(fit_samples[["A.1"]])

  M_hdi_df = data.frame(upper=M_hdi[2], lower=M_hdi[1], mean=M)
  beta_max_hdi_df = data.frame(upper=beta_max_hdi[2], lower=beta_max_hdi[1], mean=K)
  
  DF_p = select(fit_samples, paste("beta_e",1:model_data$J, sep="."))
  H = HDInterval::hdi(DF_p)
  point_df = data.frame(S = model_data$s, upper=H[2,], lower=H[1,], mean=colMeans(DF_p), pam=1:model_data$J)
  
  line_df = melt(DF_l, id = "S")
  # point_df = melt(DF_p, id = "S")
  
if (is.null(highlight)){
  g = ggplot(point_df, aes(x = S, y = mean))
} else {
  g = ggplot(point_df, aes(x = S, y = mean, fill=pam%in%highlight, color=pam%in%highlight))
}

g = g +
    xlim(0, 1) +  theme_bw()+
    ylab("Estimated Beta_E") + xlab("Predicted Strength") + labs(title=gene) + 
    scale_y_continuous(limits=c(BETA_MIN, BETA_MAX), breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0)) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
    #geom_line(data=line_df, aes(x=S, y=value, group=variable), color=DARKGRAY, alpha=1.00, size=2) +
    geom_line(data=line_df, aes(x=S, y=value, group=variable), color="#B0B0B0", alpha=1.00, size=2) +
    #geom_line(data=line_df, aes(x=S, y=value, group=variable), color="red", alpha=1.00, size=2) +
    geom_point(alpha=0.9, size=2) +
    geom_errorbar(aes(ymin=lower, ymax=upper), color=BLACK, alpha=1.0) +
    geom_line(data=DF_summary, aes(x=S, y=Y), color="black", size=2)
    ## M HDI
    if(plot_beta_max_hdi){
     g = g + geom_vline(data=M_hdi_df, aes(xintercept=upper), linetype = "dashed", color="black", size=1.2) +
      geom_vline(data=M_hdi_df, aes(xintercept=lower), linetype = "dashed", color="black", size=1.2)
    }
    ## Beta max HDI
    if(plot_beta_max_hdi){
      g = g +
      geom_hline(data=beta_max_hdi_df, aes(yintercept=upper), linetype = "dashed", color="black", size=1.2) +
      geom_hline(data=beta_max_hdi_df, aes(yintercept=lower), linetype = "dashed", color="black", size=1.2)
    }

    # geom_line(data=line_df, aes(x=S, y=value, group=variable), color="black", alpha=0.05, size=2)
  plot(g)
  extended_path = file.path(base_plot_path, "betalogistic_fit/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path, 
        paste("plot_betalogistic_fit_", strain, "_", gene, "_black.png", sep="")), dpi=300, width=width, height=height)
  
}


# Plots the logistic fit animation from samples
plot_betalogistic_fit_animation = function(gene, strain, fit_samples, model_data, base_plot_path){
  
  require(animation)
  #message(base_plot_path)
  #message(paste(base_plot_path, "logistic_fit_animation_", gene, ".gif", sep=""))
  DF_p = select(fit_samples, paste("beta_e",1:model_data$J, sep="."))
  S = seq(0, 1, 0.01)
  saveGIF({
    for(i in 1:50){
      A = fit_samples[["A.2"]][i]
      K = fit_samples[["A.1"]][i]
      B = fit_samples[["B"]][i]
      M = fit_samples[["M"]][i]
      Y = A + (K-A) / (1+exp(-B * (S-M)))
      new_l = data.frame(strength=S, Y=Y, time=i, variable=paste("y",i,sep=""))
      new_p = data.frame(beta_e = as.numeric(t(DF_p[i,])), strength=model_data$s)
      p = ggplot(new_p, aes(x = strength, y = beta_e)) +
        xlim(0, 1) +  theme_bw()+
        ylab("Estimated Beta_E") + xlab("Predicted Strength") +
        labs(title=gene, subtitle = paste("Iteration:", i)) + 
        scale_y_continuous(limits=c(BETA_MIN, BETA_MAX), breaks=waiver()) +
        theme(axis.text = element_text(size=15), title = element_text(size=18),
              axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
              axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
        geom_point(color="blue", alpha=0.6, size=2) +
        geom_line(data=new_l, aes(x=strength, y=Y, group=variable), color="black", alpha=0.6, size=2)
      plot(p)
      #ggsave(paste("logistic_fit_iteration_", gene, "_",sprintf("%04d", i), ".png", sep=""), dpi=300)
    }}, movie.name = paste("logistic_fit_animation_", gene, ".gif", sep=""), 
    img.name = paste("temp_", gene, sep=""))
  
}



first_line = function(X,a,bl,g=0,be=0){
  return(a+ bl*X)
}

second_line = function(X,a,bl,g=0,be=0){
  return(a+ bl*g + be*(X - g))
}

# Helper function describing the twoline fit.
twoline = function(X,a,bl,g,be){
  ii_L = X < g
  ii_E = X>=g
  Y = X
  Y[ii_L] = first_line(X[ii_L], a,bl,g,be)
  Y[ii_E] = second_line(X[ii_E], a, bl, g, be)
  return (Y)
}



# Plots a two line fit from samples
plot_twoline_fit = function(gene, strain, fit_samples, model_data, j, base_plot_path, samples=1000){
  
  

  ii_pam = model_data$pam==j
  data_df = data.frame(generations=model_data$x[ii_pam], 
                       Y=model_data$y[ii_pam], str=model_data$s[ii_pam])
  
  X = seq(0, 30, 0.1)

  DF_l = data.frame(X=X)
  for(i in 1:samples){
    alpha_l = fit_samples[[paste("beta.",j,".1", sep="")]][i]
    beta_l = fit_samples[[paste("beta.",j,".2",sep="")]][i]
    gamma = fit_samples[[paste("beta.",j,".3", sep="")]][i]
    beta_e = fit_samples[[paste("beta_e.",j, sep="")]][i]
    Y = twoline(X,alpha_l,beta_l,gamma,beta_e)
    DF_l[[paste("Y", i,sep="")]] = Y
  }

  line_df = melt(DF_l, id = "X")


  guide_str = model_data$s[ii_pam][1]
  C = pals::coolwarm(10000)
  color_choice = C[10000*(guide_str+0.001)]   
  
  # print(j)
  # print(model_data$s[ii_pam])
  # print(data_df)
  # print(guide_str)
  # print(color_choice)
  
  ggplot(data_df, aes(x = generations, y = Y)) +
    xlim(0, 30) +  theme_bw()+
    ylab("log2 fold-change") + xlab("Generations") +
    labs(title=paste(gene, " -  guide:", j)) + 
    scale_y_continuous(limits=c(Y_MIN, Y_MAX), breaks=c(2, 0, -2, -4, -6, -8, -10, -12)) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
    geom_line(data=line_df, aes(x=X, y=value, group=variable), color="black", alpha=0.05, size=2) +
    geom_point(color=color_choice, alpha=1.0, size=2)

  extended_path = file.path(base_plot_path, "twoline_fit/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path, 
    paste("plot_twoline_fit_", strain, "_", gene,"_j",j,  ".png", sep="")), dpi=300)
  
}



# Plots a two line fit animation from samples
plot_twoline_fit_animation = function(gene, strain, fit_samples, model_data, j, base_plot_path){
  
  require(animation)
  #message(base_plot_path)
  #message(paste(base_plot_path, "logistic_fit_animation_", gene, ".gif", sep=""))

  X = seq(0, max(model_data$x+2), 0.1)
  ii_pam = model_data$pam==j
  data_df = data.frame(generations=model_data$x[ii_pam], Y=model_data$y[ii_pam])
  
  saveGIF({
    for(i in 1:50){
      alpha_l = fit_samples[[paste("beta.",j,".1", sep="")]][i]
      beta_l = fit_samples[[paste("beta.",j,".2",sep="")]][i]
      gamma = fit_samples[[paste("beta.",j,".3", sep="")]][i]
      beta_e = fit_samples[[paste("beta_e.",j, sep="")]][i]
      Y = twoline(X,alpha_l,beta_l,gamma,beta_e)
      new_l = data.frame(generations=X, Y=Y, time=i, variable=paste("y",i,sep=""))
      
      p = ggplot(data_df, aes(x = generations, y = Y)) +
        xlim(0, 30) +  theme_bw()+
        ylab("log2 fold-change") + xlab("Generations") +
        labs(title=paste(gene, " -  guide:", j), subtitle = paste("Iteration:", i)) + 
        scale_y_continuous(limits=c(Y_MIN, Y_MAX), breaks=c(2, 0, -2, -4, -6, -8, -10, -12)) +
        theme(axis.text = element_text(size=15), title = element_text(size=18),
              axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
              axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
        geom_point(color="blue", alpha=0.6, size=2) +
        geom_line(data=new_l, aes(x=generations, y=Y, group=variable), color="black", alpha=0.6, size=2)
      plot(p)
      #ggsave(paste("logistic_fit_iteration_", gene, "_",sprintf("%04d", i), ".png", sep=""), dpi=300)
    }}, movie.name = paste("twoline_fit_animation_", gene, "_j",j, ".gif", sep=""), 
    img.name = paste("temp_", gene, sep=""))
  
}


# Plots a histogram of the vulnerability ratio
plot_ratio = function(gene, strain, fit_samples, model_data, 
                      base_plot_path, show_params=TRUE, x_lim=c(RATIO_MIN, RATIO_MAX),
                      adjust_limits=TRUE){
  
  
  K = fit_samples[["A.1"]]
  M = fit_samples[["M"]]
  hist_df = data.frame(x=K/M)
  H = HDInterval::hdi(hist_df$x)
  
  
  if(adjust_limits & H[["lower"]] < x_lim[1]){
    x_lim[1] = min(hist_df$x)
  } 
  if(adjust_limits & H[["upper"]] > x_lim[2]) {
    x_lim[2] = max(hist_df$x)
  }

  g = ggplot(hist_df, aes(x = x)) +
    ylab("Density") + 
    xlab("Vulnerability Ratio") + labs(title=gene) + 
    xlim(x_lim[1], x_lim[2]) +
    geom_histogram(aes(y=..density..),fill=DARKGRAY, alpha=1.0, size=1, bins = 150) +
    # geom_density(alpha=.2, fill="blue") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) + 
    geom_vline(xintercept = H[["lower"]], size=1.0, linetype="dashed") +
    geom_vline(xintercept = H[["upper"]], size=1.0, linetype="dashed")
  
  
  if(show_params){
    m_text = sprintf("Vulnerability Ratio: [%1.3f, %1.3f]", H[2], H[1])
    g + annotate("text",x=-Inf,y=Inf,hjust=-0.1,vjust=2,label=m_text)
  }
  
  extended_path = file.path(base_plot_path, "ratio/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path,
    paste("plot_vulnerability_ratio_", strain, "_", gene, ".png", sep="")), dpi=300)
  
}




