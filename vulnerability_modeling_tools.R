
# Vulnerability modeling tools ----

# Imports ----
library(parallel)
library(rstan)
library(reshape2)


  

# Functions ----




# Main function to  run model in parallel:
run_model = function(gene, data, strain, folder="", label=""){
  message("Gene: ", gene)
  clean_gene = gsub(":", "_", gene)
  model_data = get_model_data(gene, data)
  sample_file_path = get_gene_samples_path(gene, strain, folder=folder)
  modeldata_file_path = get_gene_model_data_path(gene, strain, folder=folder)
  fitvb <- vb(vb_model, data = model_data, grad_samples=100,tol_rel_obj=0.01, init=0,#init_r=3,
              sample_file=sample_file_path)
  saveRDS(model_data, file = modeldata_file_path)
  #plot_samples(gene, strain=strain, folder=folder, label=label)
}


# Helper function to parse data and put in format Stan likes
get_model_data = function(gene, data, y_target="Y"){
  
  ii_orf = data$ORF == gene
  Xgene = data[ii_orf,]
  Xgene$select_group = Xgene$guide_group
  ii_detectable = Xgene$detectable == "True"
  ii_good = Xgene$GOOD == "True"
  ii_select = ii_good & ii_detectable
  
  S1 = NULL
  for (i in 1:max(Xgene$select_group[ii_select]))
  {
    ii_guide = Xgene$select_group == i
    S1[i] = Xgene[ii_guide,]$STR[1]
  }
  

  # Define priors for logistic regression curve
  p_A1_mean = -0.5
  p_A2_mean = 0.0
  p_A1_std = 0.4
  p_A2_std = 0.4
  p_M_mean = 0.5
    
  
  # Data list for Stan 
  model_data = list(pam=Xgene$select[ii_select], 
                    x=Xgene$G[ii_select], 
                    y=Xgene[[y_target]][ii_select], 
                    s=array(S1), N=length(Xgene$G[ii_select]), 
                    J=max(Xgene$select_group[ii_select]), 
                    p_alpha_l_mean = 0.0, p_alpha_l_std = 1, # plateau start
                    p_beta_l_mean = 0.0, p_beta_l_std = 1,  # plateau rate
                    p_gamma_mean = 7, p_gamma_std = 2,    # transition
                    p_beta_e_mean = 0.0, p_beta_e_std = 1,  # decline rate
                    p_sigma_mean = 1, p_sigma_std = 2, # variance
                    p_A2_mean = p_A2_mean, p_A2_std = p_A2_std,
                    p_A1_mean=p_A1_mean, p_A1_std = p_A1_std,
                    L=c(-0.2, -0.5,  2),
                    U=c( 0.2,    4, 28),
                    kappa=5, rho=p_M_mean,
                    prior=0
  )  
  
  return (model_data)
}     
